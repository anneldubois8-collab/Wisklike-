<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Wishlike (Mobile – Diagnostic)</title>
<style>
  :root{--bg:#0f0f0f;--fg:#f3f3f3;--muted:#bdbdbd;--panel:#161616;--border:#2a2a2a;--hud-h:56px;--safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom);}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-rounded,-apple-system,system-ui,Segoe UI,Roboto,Arial}
  #app{height:100%;display:flex;flex-direction:column}
  .hud{position:sticky;top:0;padding:10px calc(12px + var(--safe-top));height:var(--hud-h);background:#121212;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-size:16px}
  .title{font-weight:700;margin-right:auto}
  .badge{background:#1d1d1d;border:1px solid var(--border);padding:6px 10px;border-radius:10px;color:var(--muted)}
  #log{flex:1;overflow:auto;padding:14px 14px 24px 14px;line-height:1.35;font-size:18px;background:var(--panel)}
  .footer{position:sticky;bottom:0;background:#121212;border-top:1px solid var(--border);padding-bottom:calc(8px + var(--safe-bottom))}
  .quickbar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:12px}
  .qbtn{font-size:16px;padding:12px 10px;background:#1b1b1b;color:#fff;border:1px solid var(--border);border-radius:10px}
  .qbtn:active{transform:scale(0.98)}
  .promptline{display:flex;gap:8px;padding:10px;padding-top:0}
  #input{flex:1;font-size:18px;padding:14px 12px;background:#161616;color:#fff;border:1px solid var(--border);border-radius:10px}
  #btn{font-size:18px;font-weight:700;padding:14px 16px;background:#35d07f;color:#000;border:none;border-radius:10px}
  @media (max-width:380px){.quickbar{grid-template-columns:repeat(4,1fr)}}
  #errors{display:none;margin:8px 14px;background:#3b0f12;border:1px solid #632529;border-radius:8px;color:#ffd4d4;padding:10px;font-size:14px;white-space:pre-wrap}
  #diag{display:flex;gap:8px;padding:0 14px 8px 14px}
  #diag button{font-size:14px;padding:8px 10px;background:#1b1b1b;color:#fff;border:1px solid var(--border);border-radius:8px}
</style>
</head>
<body>
<div id="app">
  <div class="hud">
    <div class="title">Wishlike</div>
    <div class="badge" id="loc">—</div>
    <div class="badge" id="time">Turn 0</div>
  </div>

  <div id="errors" aria-live="polite"></div>
  <div id="diag">
    <button id="ping">Self-test: Ping</button>
    <button id="sendlook">Self-test: Send LOOK</button>
  </div>

  <div id="log" aria-live="polite">Welcome to Wishlike.</div>

  <div class="footer">
    <div class="quickbar" aria-label="Quick actions">
      <button class="qbtn" data-cmd="LOOK">LOOK</button>
      <button class="qbtn" data-cmd="I">INV</button>
      <button class="qbtn" data-cmd="HELP">HELP</button>
      <button class="qbtn" data-cmd="N">N</button>
      <button class="qbtn" data-cmd="S">S</button>
      <button class="qbtn" data-cmd="E">E</button>
      <button class="qbtn" data-cmd="W">W</button>
    </div>
    <div class="promptline">
      <input id="input" type="text" inputmode="latin" autocomplete="off" autocapitalize="characters" autocorrect="off"
             placeholder="Type a command (e.g., WISH FOR LIGHT)" />
      <button id="btn" aria-label="Enter command">Enter</button>
    </div>
  </div>
</div>

<script>
(function(){
  /* Error box on page */
  const errBox = document.getElementById('errors');
  function showError(msg){
    errBox.style.display='block';
    errBox.textContent += (errBox.textContent ? "\n" : "") + "[JS ERROR] " + msg;
  }
  window.addEventListener('error', e => showError(e && e.message ? e.message : String(e)));

  /* Log helpers */
  const logEl = document.getElementById('log');
  function appendHTML(text){
    const html = String(text).replace(/\n/g,'<br>');
    logEl.innerHTML += (logEl.innerHTML ? '<br>' : '') + html;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function say(t){ appendHTML(t); }

  /* HUD refs */
  const locEl = document.getElementById('loc');
  const timeEl= document.getElementById('time');
  function setHUD(){ locEl.textContent = room().name; timeEl.textContent = 'Turn ' + game.turn; }

  /* Minimal game (same as before) */
  const game = {
    turn: 0,
    flags: { light:false, gateOpen:false, catFreed:false, stoneAwake:false, won:false },
    inventory: [],
    start: "green_gables_path",
    rooms: {
      "green_gables_path": {
        name: "Pebble Lane, Twilight",
        desc: (g) => `You stand on Pebble Lane as dusk smothers the village. To the east, the lane bends toward a ${g.flags.gateOpen ? "yawning, open gate" : "rusted iron gate"} set in a low wall. West leads back toward the harbor lamps.\nA crooked sign reads: “Deliveries to Green Gables — ${g.flags.catFreed ? "Thank you." : "After dark, beware the cat.”"}`,
        exits: { west: "harbor_edge", east: "gate_road" },
        items: ["sign", "lamp_post"]
      },
      "harbor_edge": {
        name: "Harbor Edge",
        desc: (g)=>`Salt rides the air. Black water laps at barnacled pilings. The faint shape of a ${has("rowboat") ? "tied rowboat" : "rowboat drifting just out of reach"} bobs nearby.`,
        exits: { east: "green_gables_path" },
        items: ["pebbles", "rowboat_out"]
      },
      "gate_road": {
        name: "Green Gables Gate",
        desc: (g)=>`The road ends at a low wall and an iron gate ${g.flags.gateOpen ? "hanging ajar" : "locked tight"}. Beyond, a garden path loses itself in shadow.\nA ${has("cat") || g.flags.catFreed ? "contented" : "watchful"} cat watches from the wall.`,
        exits: { west: "green_gables_path", east: g.flags.gateOpen ? "garden" : null },
        items: ["gate","cat","note"]
      },
      "garden": {
        name: "Green Gables Garden",
        desc: (g)=>`Night presses between hedges. A porch light is dead. A ${g.flags.light ? "faint glow reveals a brass key under a flowerpot" : "flowerpot sits in gloom; something might be beneath"}.\nThe front door faces north.`,
        exits: { west: "gate_road", north: "porch" },
        items: ["flowerpot"]
      },
      "porch": {
        name: "Porch of Green Gables",
        desc: (g)=>`Wooden steps creak. The door is ${has("house_key") ? "unlocked if you choose" : "locked"}. A brass plaque reads: “Deliver biscuits; mind the cat.”`,
        exits: { south: "garden", inside: has("house_key") ? "foyer" : null },
        items: ["door","plaque"]
      },
      "foyer": {
        name: "Foyer",
        desc: (g)=>`A quiet foyer with the smell of tea and ink. On a small table lies a sealed envelope addressed “To the Deliverer.”`,
        exits: { outside: "porch" },
        items: ["envelope"]
      }
    },
    items: {
      "sign": { name: "crooked sign", article:"the", portable:false, desc:`“Deliveries to Green Gables — After dark, beware the cat.”` },
      "lamp_post": { name:"lamp post", article:"the", portable:false, desc:`An unlit gas lamp.` },
      "pebbles": { name:"handful of pebbles", article:"a", portable:true, desc:`Smooth, flat pebbles.`, verbs:{ use:(g)=>say(`You skip a pebble.`) } },
      "rowboat_out": { name:"rowboat", article:"a", portable:false, desc:(g)=>has("rowboat")?`A small rowboat tied to a post.`:`It bobs just out of reach.`, verbs:{
        take:(g)=> { if (has("rowboat")) return say(`Already got it tied up.`); if (g.flags.stoneAwake) { addInv("rowboat"); say(`The rowboat drifts close enough to tie. You secure it.`);} else { say(`You stretch and splash. No luck.`);} }
      }},
      "gate": { name:"iron gate", article:"the", portable:false, desc:(g)=> g.flags.gateOpen ? `Old, creaky, and now open.` : `Locked tight with a corroded lock.`, verbs:{
        open:(g)=> { if (g.flags.gateOpen) return say(`Already open.`); if (has("house_key")) { g.flags.gateOpen=true; say(`The gate swings open.`);} else { say(`It won't budge.`);} }
      }},
      "cat": { name:"cat", article:"a", portable:false, desc:(g)=> g.flags.catFreed ? `A purring guardian.`:`A wary cat, eyes like coals.`, verbs:{
        talk:(g)=> { if (!g.flags.catFreed) return say(`“Mrrrp.” It eyes your hands.`); say(`The cat chirps.`); }
      }},
      "note": { name:"note", article:"a", portable:true, desc:`“Payment enclosed. Bring biscuits.”`, verbs:{ read:()=>say(`It says to bring biscuits.`) }},
      "flowerpot": { name:"flowerpot", article:"a", portable:false, desc:(g)=> g.flags.light ? `A clay pot. A brass key glints beneath.`:`A clay pot. Too dark to see under.`, verbs:{
        look:(g)=> { if (!g.flags.light) return say(`Too dark to see.`); if (!has("house_key")) { addInv("house_key"); say(`You find a brass key. Taken.`);} else say(`Nothing else.`);}
      }},
      "door": { name:"front door", article:"the", portable:false, desc:(g)=> has("house_key") ? `The door will open for a friend with a key.`:`Locked.` , verbs:{
        open:(g)=> { if (!has("house_key")) return say(`Locked.`); say(`You unlock the door.`); move("foyer"); }
      }},
      "plaque": { name:"plaque", article:"a", portable:false, desc:`“Deliver biscuits; mind the cat.”` },
      "envelope": { name:"sealed envelope", article:"a", portable:true, desc:`Heavy paper; something rattles.`, verbs:{
        open:(g)=> { removeFromRoomOrInv("envelope"); addInv("wishstone"); addInv("biscuits"); say(`Inside: biscuits and a smooth stone.`); }
      }},
      "wishstone": { name:"wishstone", article:"the", portable:true, desc:`A smooth, opalescent stone.`, verbs:{
        use:(g)=> say(`If you mean to WISH, say “WISH FOR …”.`),
        read:()=> say(`Runes: Light. Near. Open. Calm.`)
      }},
      "biscuits": { name:"bag of biscuits", article:"a", portable:true, desc:`Warm biscuits.`, verbs:{
        use:(g)=> { if (at("gate_road") && !game.flags.catFreed) { game.flags.catFreed=true; say(`The cat devours a biscuit and hops aside.`);} else say(`You have a nibble.`);}
      }},
      "house_key": { name:"brass key", article:"a", portable:true, desc:`Well-worn.` },
      "rowboat": { name:"rowboat", article:"a", portable:true, desc:`A small tied rowboat.` }
    }
  };

  /* Engine helpers */
  function room(){ return game.rooms[game.here]; }
  function itemsHere(){ return room().items || []; }
  function has(id){ return game.inventory.includes(id); }
  function addInv(id){ if (!has(id)) game.inventory.push(id); }
  function removeFromRoomOrInv(id){ const r=room(); if(r.items){ r.items=r.items.filter(x=>x!==id);} game.inventory=game.inventory.filter(x=>x!==id); }
  function at(id){ return game.here===id; }
  function nameOf(id){ const it=game.items[id]; return it ? (typeof it.name==="function"?it.name(game):it.name) : id; }
  function articleName(id){ const it=game.items[id]; if(!it) return id; const nm=nameOf(id); const art=it.article??"a"; if(art==="the") return `the ${nm}`; const v=/^[aeiou]/i.test(nm); return `${v?"an":"a"} ${nm}`; }

  /* Parser */
  const verbs = {
    look: doLook, l:doLook, examine: doExamine, x: doExamine,
    go: doGo, north:(o)=>doGo(["go","north"]), n:(o)=>doGo(["go","north"]),
    south:(o)=>doGo(["go","south"]), s:(o)=>doGo(["go","south"]),
    east:(o)=>doGo(["go","east"]), e:(o)=>doGo(["go","east"]),
    west:(o)=>doGo(["go","west"]), w:(o)=>doGo(["go","west"]),
    inside:(o)=>doGo(["go","inside"]), outside:(o)=>doGo(["go","outside"]),
    take: doTake, get: doTake, drop: doDrop, inventory: doInv, i: doInv,
    open: doOpen, read: doRead, use: doUse, talk: doTalk, wish: doWish,
    save: doSave, load: doLoad, help: doHelp, restart: doRestart,
    unlock:(o)=>doOpen(o), give:(o)=>doGive(o),
  };
  const synonyms = {"lamp":"lamp_post","post":"lamp_post","pebble":"pebbles","boat":"rowboat_out","key":"house_key","brass key":"house_key","biscuit":"biscuits","envelope":"envelope"};
  function normalizeNoun(n){ if(!n) return null; n=n.trim().toLowerCase(); if(["north","south","east","west","inside","outside"].includes(n)) return n; return synonyms[n]||n; }
  function resolveItem(noun){
    noun = normalizeNoun(noun); if(!noun) return null;
    if (game.items[noun]){ if (has(noun)||itemsHere().includes(noun)||noun.endsWith("_out")) return noun; }
    const candidates = Object.keys(game.items).filter(id=>{
      const it=game.items[id]; const nm=(typeof it.name==="function"?it.name(game):it.name).toLowerCase();
      return nm.includes(noun);
    });
    return candidates.find(id=>has(id)||itemsHere().includes(id)||id.endsWith("_out")) || null;
  }

  /* Actions */
  function describeRoom(){
    const r = room();
    const desc = typeof r.desc === "function" ? r.desc(game) : r.desc;
    say(`\n${r.name}\n${desc}`);
    const items = itemsHere().filter(id=>!id.endsWith("_out") && game.items[id]);
    if (items.length) say(`You see ${items.map(id=>articleName(id)).join(", ")}.`);
  }
  function doHelp(){ say(`Commands: LOOK/L, EXAMINE/X <thing>, GO/G <N|S|E|W|INSIDE|OUTSIDE>, TAKE/GET <item>, DROP <item>, INVENTORY/I, OPEN/UNLOCK <thing>, READ <thing>, USE <thing>, TALK <to>, GIVE <item> TO <who>, WISH FOR <LIGHT|NEAR|OPEN|CALM>, SAVE, LOAD, RESTART.`); }
  function doLook(){ describeRoom();
